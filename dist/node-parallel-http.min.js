function checkInfos(n){return new Promise(function(e,t){n?n.sites||t("no site in info"):t("no info"),e(n)})}function processOnePage(n,e,t){return new Promise(function(o,r){e(n).then(checkInfos).then(function(r){0===r.sites.length?o("Finish"):traiterInfo(r,e,t).then(function(){return processOnePage(n,e,t)}).then(function(n){o(n)})})["catch"](function(n){console.log("Err: "+n),r("Err: "+n,null)})})}function traiterInfo(n,e,t){return new Promise(function(o,r){getPage(n).then(function(n){return t(n[0],n[1])}).then(function(n){n.pageIndex==n.sites.length?o(null,null):traiterInfo(n,e,t).then(function(n){o(null,n)})})})}function createListParallelCurl(n,e,t){for(var o=Promise.denodeify(e),r=Promise.denodeify(t),i=[],c=0;n>c;c++)i[i.length]=function(n){return function(e){processOnePage(n,o,r).then(function(t){e(null,{index:n,content:t})})["catch"](function(n){e(n,null)})}}(c);return i}function start(n,e,t,o,r){return new Promise(function(r,i){http=selectHttpEngine(o);var c=createListParallelCurl(n,e,t);launchEachCurlParallel(c).then(function(n){r(n)})["catch"](function(n){i(n)})})}function launchEachCurlParallel(n){return new Promise(function(e,t){asyncParallel=Promise.denodeify(async.parallel),asyncParallel(n).then(function(n){e(n)})["catch"](function(n){t(n)})})}function selectHttpEngine(n){return"undefined"!=typeof n&&n?require("socks5-http-client"):require("http")}function callbackHttp(n,e){var t="";n.on("data",function(n){t+=n}),n.on("end",function(){e(null,t)})}var async=require("async"),Promise=require("promise"),http;module.exports=start;var getPage=Promise.denodeify(function n(e,t){"undefined"==typeof e.pageIndex&&(e.pageIndex=0);var o={host:e.sites[e.pageIndex].url,path:e.sites[e.pageIndex].path,port:"80",socksPort:9050},r=http.request(o,function(n){callbackHttp(n,function(n,o){e.pageIndex++,e.sites[e.pageIndex-1].isValid(o)?t(n,[o,e]):(e.pageIndex--,getPage(e,t))})});r.on("socket",function(n){n.setTimeout(1e4),n.on("timeout",function(){r.abort()}),n.setMaxListeners(300)}),r.on("error",function(o){console.log("problem with request: "+o.message),n(e,t)}),r.end()});
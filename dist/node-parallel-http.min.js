function processOnePage(n,e,t,o){e(n).then(Promise.denodeify(function(n,r){if(!n)throw new Error("no info");if(!n.sites)throw new Error("no site in info");0===n.sites.length?o(null,"Finish"):traiterInfo(n,e,t,r)})).then(function(){processOnePage(n,e,t,o)})["catch"](function(n){console.log("Err: "+n),o("Err: "+n,null)})}function traiterInfo(n,e,t,o){getPage(n).then(Promise.denodeify(function(n,r){var i=n[1];i.sites[i.pageIndex-1].isValid(n[0])?t(n[0],n[1],r):(i.pageIndex--,traiterInfo(i,e,t,o))})).then(function(n,r){n.pageIndex==n.sites.length?o(null,null):traiterInfo(n,e,t,o)})}function createListParallelCurl(n,e,t){for(var o=Promise.denodeify(e),r=Promise.denodeify(t),i=[],a=0;n>a;a++)i[i.length]=function(n){return function(e){processOnePage(n,o,r,function(t,o){e(null,{index:n,content:o})})}}(a);return i}function start(n,e,t,o,r){return new Promise(function(r,i){http=selectHttpEngine(o);var a=createListParallelCurl(n,e,t);launchEachCurlParallel(a).then(function(n){r(n)})["catch"](function(n){i(n)})})}function launchEachCurlParallel(n){return new Promise(function(e,t){asyncParallel=Promise.denodeify(async.parallel),asyncParallel(n).then(function(n){e(n)})["catch"](function(n){t(n)})})}function selectHttpEngine(n){return"undefined"!=typeof n&&n?require("socks5-http-client"):require("http")}function callbackHttp(n,e){var t="";n.on("data",function(n){t+=n}),n.on("end",function(){e(null,t)})}var async=require("async"),Promise=require("promise"),http;module.exports=start;var getPage=Promise.denodeify(function n(e,t){"undefined"==typeof e.pageIndex&&(e.pageIndex=0);var o={host:e.sites[e.pageIndex].url,path:e.sites[e.pageIndex].path,port:"80",socksPort:9050},r=http.request(o,function(n){callbackHttp(n,function(n,o){e.pageIndex++,t(n,[o,e])})});r.on("socket",function(n){n.setTimeout(1e4),n.on("timeout",function(){r.abort()}),n.setMaxListeners(300)}),r.on("error",function(o){console.log("problem with request: "+o.message),n(e,t)}),r.end()});
function callbackHttp(e,n){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){n(null,t)})}function processOnePage(e,n,t,o){n(e).then(Promise.denodeify(function(e,r){if(!e)throw new Error("no info");if(!e.sites)throw new Error("no site in info");0===e.sites.length?o(null,"Finish"):traiterInfo(e,n,t,r)})).then(function(){processOnePage(e,n,t,o)})["catch"](function(e){console.log("Err: "+e),o("Err: "+e,null)})}function traiterInfo(e,n,t,o){getPage(e).then(Promise.denodeify(function(e,r){var i=e[1];i.sites[i.pageIndex-1].isValid(e[0])?t(e[0],e[1],r):(i.pageIndex--,traiterInfo(i,n,t,o))})).then(function(e,r){e.pageIndex==e.sites.length?o(null,null):traiterInfo(e,n,t,o)})}function createListParallelCurl(e,n,t){for(var o=Promise.denodeify(n),r=Promise.denodeify(t),i=[],a=0;e>a;a++)i[i.length]=function(e){return function(n){processOnePage(e,o,r,function(t,o){n(null,e+" "+o)})}}(a);return i}function start(e,n,t,o,r){http=selectHttpEngine(o);var i=createListParallelCurl(e,n,t);launchEachCurlParallel(i,r)}function launchEachCurlParallel(e,n){async.parallel(e,n)}function selectHttpEngine(e){return"undefined"!=typeof e&&e?require("socks5-http-client"):require("http")}var async=require("async"),Promise=require("promise"),http,getPage=Promise.denodeify(function e(n,t){"undefined"==typeof n.pageIndex&&(n.pageIndex=0);var o={host:n.sites[n.pageIndex].url,path:n.sites[n.pageIndex].path,port:"80",socksPort:9050},r=http.request(o,function(e){callbackHttp(e,function(e,o){n.pageIndex++,t(e,[o,n])})});r.on("socket",function(e){e.setTimeout(1e4),e.on("timeout",function(){r.abort()}),e.setMaxListeners(300)}),r.on("error",function(o){console.log("problem with request: "+o.message),e(n,t)}),r.end()});module.exports=start;
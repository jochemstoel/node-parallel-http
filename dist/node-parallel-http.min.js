function processOnePage(n,e,t){return new Promise(function(o,i){e(n).then(Promise.denodeify(function(n,r){n?n.sites||i("no site in info"):i("no info"),0===n.sites.length?o("Finish"):traiterInfo(n,e,t,r)})).then(function(){processOnePage(n,e,t).then(function(n){o(n)})})["catch"](function(n){console.log("Err: "+n),i("Err: "+n,null)})})}function traiterInfo(n,e,t,o){getPage(n).then(Promise.denodeify(function(n,i){var r=n[1];r.sites[r.pageIndex-1].isValid(n[0])?t(n[0],n[1],i):(r.pageIndex--,traiterInfo(r,e,t,o))})).then(function(n,i){n.pageIndex==n.sites.length?o(null,null):traiterInfo(n,e,t,o)})}function createListParallelCurl(n,e,t){for(var o=Promise.denodeify(e),i=Promise.denodeify(t),r=[],a=0;n>a;a++)r[r.length]=function(n){return function(e){processOnePage(n,o,i).then(function(t){e(null,{index:n,content:t})})["catch"](function(n){e(n,null)})}}(a);return r}function start(n,e,t,o,i){return new Promise(function(i,r){http=selectHttpEngine(o);var a=createListParallelCurl(n,e,t);launchEachCurlParallel(a).then(function(n){i(n)})["catch"](function(n){r(n)})})}function launchEachCurlParallel(n){return new Promise(function(e,t){asyncParallel=Promise.denodeify(async.parallel),asyncParallel(n).then(function(n){e(n)})["catch"](function(n){t(n)})})}function selectHttpEngine(n){return"undefined"!=typeof n&&n?require("socks5-http-client"):require("http")}function callbackHttp(n,e){var t="";n.on("data",function(n){t+=n}),n.on("end",function(){e(null,t)})}var async=require("async"),Promise=require("promise"),http;module.exports=start;var getPage=Promise.denodeify(function n(e,t){"undefined"==typeof e.pageIndex&&(e.pageIndex=0);var o={host:e.sites[e.pageIndex].url,path:e.sites[e.pageIndex].path,port:"80",socksPort:9050},i=http.request(o,function(n){callbackHttp(n,function(n,o){e.pageIndex++,t(n,[o,e])})});i.on("socket",function(n){n.setTimeout(1e4),n.on("timeout",function(){i.abort()}),n.setMaxListeners(300)}),i.on("error",function(o){console.log("problem with request: "+o.message),n(e,t)}),i.end()});
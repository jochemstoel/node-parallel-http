function checkInfos(n){return new Promise(function(e,t){if(n||t("Function getInfos need to return infos"),"undefined"==typeof n.pageIndex&&(n.pageIndex=0),n.sites)for(var i=0;i<n.sites.length;i++)n.sites[i].path||(n.sites[i].path=""),n.sites[i].isValid||(n.sites[i].isValid=function(){return!0});else n.sites=[];e(n)})}function processAllPages(n,e,t){return new Promise(function(i,o){return e?void e(n).then(checkInfos).then(function(s){0===s.sites.length?i("Finish"):getPages(s,e,t).then(function(){return processAllPages(n,e,t)}).then(function(n){i(n)})["catch"](function(n){o(n)})})["catch"](function(n){o(n)}):void o("processAllPages : missing getInfos")})}function getPages(n,e,t){return new Promise(function(i,o){getPage(n).then(function(n){var e=n[0],i=n[1];return t(e,i)}).then(function(n){n.pageIndex==n.sites.length?i(null,null):getPages(n,e,t).then(function(n){i(null,n)})})})}function createListParallelCurl(n,e,t){for(var i=Promise.denodeify(e),o=Promise.denodeify(t),s=[],r=0;n>r;r++)s[s.length]=function(n){return function(e){processAllPages(n,i,o).then(function(t){e(null,{index:n,content:t})})["catch"](function(n){e(n,null)})}}(r);return s}function start(n,e,t,i,o){return new Promise(function(o,s){http=selectHttpEngine(i);var r=createListParallelCurl(n,e,t);launchEachCurlParallel(r).then(function(n){o(n)})["catch"](function(n){s(n)})})}function launchEachCurlParallel(n){return new Promise(function(e,t){asyncParallel=Promise.denodeify(async.parallel),asyncParallel(n).then(function(n){e(n)})["catch"](function(n){t(n)})})}function selectHttpEngine(n){return"undefined"!=typeof n&&n?require("socks5-http-client"):require("http")}function callbackHttp(n,e){var t="";n.on("data",function(n){t+=n}),n.on("end",function(){e(null,t)})}var async=require("async"),Promise=require("promise"),http;module.exports=start;var getPage=Promise.denodeify(function n(e,t){var i={host:e.sites[e.pageIndex].url,path:e.sites[e.pageIndex].path,port:"80",socksPort:9050},o=http.request(i,function(n){callbackHttp(n,function(n,i){e.pageIndex++,e.sites[e.pageIndex-1].isValid(i)?t(n,[i,e]):(e.pageIndex--,getPage(e,t))})});o.on("socket",function(n){n.setTimeout(1e4),n.on("timeout",function(){o.abort()}),n.setMaxListeners(300)}),o.on("error",function(i){n(e,t)}),o.end()});
function callbackHttp(e,n){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){n(null,t)})}function processOnePage(e,n,t,o){n(e).then(Promise.denodeify(function(e,i){e?e.sites||console.log("il n y a pas de site dans infos"):console.log("il n y a pas d'info"),0===e.sites.length?o(null,"fini"):traiterInfo(e,n,t,i)})).then(function(){processOnePage(e,n,t,o)})}function traiterInfo(e,n,t,o){getPage(e).then(Promise.denodeify(function(e,i){var r=e[1];r.sites[r.pageIndex-1].isValid(e[0])?t(e[0],e[1],i):(r.pageIndex--,traiterInfo(r,n,t,o))})).then(function(e,i){e.pageIndex==e.sites.length?o(null,null):traiterInfo(e,n,t,o)})}function createListParallelCurl(e,n,t){for(var o=Promise.denodeify(n),i=Promise.denodeify(t),r=[],a=0;e>a;a++)r[r.length]=function(e){return function(n){processOnePage(e,o,i,function(t,o){n(null,e+" "+o)})}}(a);return r}function start(e,n,t,o,i){http=selectHttpEngine(o);var r=createListParallelCurl(e,n,t);launchEachCurlParallel(r,i)}function launchEachCurlParallel(e,n){async.parallel(e,n)}function selectHttpEngine(e){return"undefined"!=typeof e&&e?require("socks5-http-client"):require("http")}var async=require("async"),Promise=require("promise"),http,getPage=Promise.denodeify(function e(n,t){"undefined"==typeof n.pageIndex&&(n.pageIndex=0);var o={host:n.sites[n.pageIndex].url,path:n.sites[n.pageIndex].path,port:"80",socksPort:9050},i=http.request(o,function(e){callbackHttp(e,function(e,o){n.pageIndex++,t(e,[o,n])})});i.on("socket",function(e){e.setTimeout(1e4),e.on("timeout",function(){i.abort()}),e.setMaxListeners(300)}),i.on("error",function(o){console.log("problem with request: "+o.message),e(n,t)}),i.end()});module.exports=start;
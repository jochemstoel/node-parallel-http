function callbackHttp(e,n){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){n(null,t)})}function crawlerOnePage(e,n,t,r){n(e).then(Promise.denodeify(function(e,i){0===e.sites.length?r(null,"fini"):traiterInfo(e,n,t,i)})).then(function(){crawlerOnePage(e,n,t,r)})}function traiterInfo(e,n,t,r){getPage(e).then(Promise.denodeify(function(e,i){var o=e[1];o.sites[o.pageIndex-1].isValid(e[0])?t(e[0],e[1],i):(o.pageIndex--,traiterInfo(o,n,t,r))})).then(function(e,i){e.pageIndex==e.sites.length?r(null,null):traiterInfo(e,n,t,r)})}function createListParallelCurl(e,n,t){for(var r=Promise.denodeify(n),i=Promise.denodeify(t),o=[],a=0;e>a;a++)o[o.length]=function(e){return function(n){crawlerOnePage(e,r,i,function(t,r){n(null,e+" "+r)})}}(a);return o}function start(e,n,t,r,i){http=selectHttpEngine(r);var o=createListParallelCurl(e,n,t);launchEachCurlParallel(o,i)}function launchEachCurlParallel(e,n){async.parallel(e,n)}function selectHttpEngine(e){return"undefined"!=typeof e&&e?require("socks5-http-client"):require("http")}var async=require("async"),Promise=require("promise"),http,getPage=Promise.denodeify(function e(n,t){"undefined"==typeof n.pageIndex&&(n.pageIndex=0);var r={host:n.sites[n.pageIndex].url,path:n.sites[n.pageIndex].path,port:"80",socksPort:9050},i=http.request(r,function(e){callbackHttp(e,function(e,r){n.pageIndex++,t(e,[r,n])})});i.on("socket",function(e){e.setTimeout(1e4),e.on("timeout",function(){i.abort()}),e.setMaxListeners(300)}),i.on("error",function(r){console.log("problem with request: "+r.message),e(n,t)}),i.end()});module.exports=start;
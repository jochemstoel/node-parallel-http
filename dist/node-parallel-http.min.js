function checkInfos(n){return new Promise(function(e,t){n||t("Function getInfos need to return infos"),n.sites||(n.sites=[]),e(n)})}function processAllPages(n,e,t){return new Promise(function(o,i){return e?void e(n).then(checkInfos).then(function(r){0===r.sites.length?o("Finish"):getPages(r,e,t).then(function(){return processAllPages(n,e,t)}).then(function(n){o(n)})["catch"](function(n){i(n)})})["catch"](function(n){i(n)}):void i("processAllPages : missing getInfos")})}function getPages(n,e,t){return new Promise(function(o,i){getPage(n).then(function(n){return t(n[0],n[1])}).then(function(n){n.pageIndex==n.sites.length?o(null,null):getPages(n,e,t).then(function(n){o(null,n)})})})}function createListParallelCurl(n,e,t){for(var o=Promise.denodeify(e),i=Promise.denodeify(t),r=[],c=0;n>c;c++)r[r.length]=function(n){return function(e){processAllPages(n,o,i).then(function(t){e(null,{index:n,content:t})})["catch"](function(n){e(n,null)})}}(c);return r}function start(n,e,t,o,i){return new Promise(function(i,r){http=selectHttpEngine(o);var c=createListParallelCurl(n,e,t);launchEachCurlParallel(c).then(function(n){i(n)})["catch"](function(n){r(n)})})}function launchEachCurlParallel(n){return new Promise(function(e,t){asyncParallel=Promise.denodeify(async.parallel),asyncParallel(n).then(function(n){e(n)})["catch"](function(n){t(n)})})}function selectHttpEngine(n){return"undefined"!=typeof n&&n?require("socks5-http-client"):require("http")}function callbackHttp(n,e){var t="";n.on("data",function(n){t+=n}),n.on("end",function(){e(null,t)})}var async=require("async"),Promise=require("promise"),http;module.exports=start;var getPage=Promise.denodeify(function n(e,t){"undefined"==typeof e.pageIndex&&(e.pageIndex=0);var o={host:e.sites[e.pageIndex].url,path:e.sites[e.pageIndex].path,port:"80",socksPort:9050},i=http.request(o,function(n){callbackHttp(n,function(n,o){e.pageIndex++,e.sites[e.pageIndex-1].isValid(o)?t(n,[o,e]):(e.pageIndex--,getPage(e,t))})});i.on("socket",function(n){n.setTimeout(1e4),n.on("timeout",function(){i.abort()}),n.setMaxListeners(300)}),i.on("error",function(o){n(e,t)}),i.end()});